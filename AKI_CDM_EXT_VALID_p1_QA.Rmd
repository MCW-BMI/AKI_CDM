---
title: "Building and Validating Predictive Models for Acute Kidney Injury (AKI) using PCORnet CDM (Part I)"
author: "xing song"
date: "August 23, 2018"
output: html_document
---
### Aim 1: Data Feasibility Evaluation over GPC sites.
#### Objective 1.1: Study cohort extraction and characterization

##### Inclusion criteria:

* (IP,IS,EI) visits with length of stay (LOS) >= 2 days; 
* age at visit >= 18 years old

***

##### Exclusion criteria:

* had no documented SCr measurements during admission; 
* had initial SCr greater than or equal to 1.3 mg/dL; 
* developed stage 2 AKI (eGFR <= 15 mL/min per 1.73m^2) initially; 
* pre-existing chronic renal failure (DX); 
* received RRT within 48 hours since admission; 
* burn patients (DRG)

***

##### AKI Staging

AKI Stages are defined based on [KDIGO](http://www.kdigo.org/clinical_practice_guidelines/pdf/KDIGO%20AKI%20Guideline.pdf):

* AKI 1: increase in serum creatinine by >=**0.3 mg/dL** within **48 hours** OR **1.5-1.9 times** baseline within **7 days**; 
* AKI 2: **2.0 to 2.9 times** baseline within **7 days**; 
* AKI 3: increase in serum creatinine to >= **4.0 mg/dL** within **48 hours** OR **3.0 times** baseline within **7 days**


##### Implementation: Extracting AKI Study Cohort
```{r eval=FALSE}
#source utility functions
source("./R/helper_functions.R")

#load libraries
require_libraries(c("knitr",
                    "tidyr",
                    "dplyr",
                    "magrittr",
                    "stringr",
                    "ROracle",
                    "DBI"))


#establish the connection between r-studio and CDM server
config_file_path<-"../herona1_config.csv"
config_file<-read.csv(config_file_path,stringsAsFactors = F)
conn<-dbConnect(Oracle(),
                config_file$username,
                config_file$password,
                config_file$access)

#extract cohort --Table1
cohort<-extract_cohort(conn,
                       cdm_db_schema="PCORNET_CDM_C4R3",
                       oracle_temp_schema=cdm_db_schema,
                       start_date="2010-01-01",
                       end_date="2018-12-31")

#save Table1
Table1<-cohort$aki_enc
save(Table1,file="./data/Table1.Rdata")
```

The above codes extracted AKI study cohort based on the "Inclusion" and "Exclusion" criteria specified above. The final output was automatically saved in the current working directory *r getwd()* as "Table1.Rdata" with columns: *r paste(colnames(Table1),collapse=","*. The following attrition table shows the loss of samples during the collection process, which finally resulted in *r length(unique(Table1$ENCOUNTERID))*. 


```{r eval=FALSE}
#nice print-out of attrition table
kabel(cohort$attrition,caption="Attrition Table")
```


#### Objective 1.2: Variable Collection (Table by Table) 

##### Demographic
```{r echo=F, eval=F}
# if date are not in proper format
Table1 %<>%
  dplyr::mutate(ADMIT_DATE=as.Date(as.character(ADMIT_DATE),"%Y-%m-%d"),
                DISCHARGE_DATE=as.Date(as.character(DISCHARGE_DATE),"%Y-%m-%d"),
                AKI1_ONSET=as.Date(as.character(AKI1_ONSET),"%Y-%m-%d"),
                AKI2_ONSET=as.Date(as.character(AKI2_ONSET),"%Y-%m-%d"),
                AKI3_ONSET=as.Date(as.character(AKI3_ONSET),"%Y-%m-%d"))

enc_tot<-length(unique(Table1$ENCOUNTERID))

# get AKI stage index
aki_stage_ind<-tbl1 %>%
  dplyr::select(ENCOUNTERID,
                AKI1_SINCE_ADMIT,AKI2_SINCE_ADMIT,AKI3_SINCE_ADMIT) %>%
  gather(aki_stg, days_since, -ENCOUNTERID) %>%
  filter(!is.na(days_since)) %>%
  dplyr::select(ENCOUNTERID, aki_stg)%>%
  mutate(aki_stg=gsub("_.*","",aki_stg)) %>%
  group_by(aki_stg) %>%
  dplyr::mutate(stg_tot_cnt=n()) %>%
  ungroup %>%
  arrange(ENCOUNTERID, aki_stg, stg_tot_cnt)

```

```{r echo=F, eval=F}
# collect demographic summaries
demo_summ<-aki_stage_ind %>%
  left_join(demo %>%
              dplyr::select(-AGE) %>%
              gather(demo_type,demo_val,-PATID, -ENCOUNTERID), 
            by="ENCOUNTERID") %>%
  group_by(aki_stg,stg_tot_cnt,demo_type,demo_val) %>%
  dplyr::summarize(enc_cnt = n(),
                   enc_prop = round(n()/stg_tot_cnt[1],2)) %>%
  ungroup %>% dplyr::select(-stg_tot_cnt) %>%
  gather(summ,summ_val,-aki_stg,-demo_type,-demo_val) %>%
  # decode demo_val
  left_join(meta %>% dplyr::select(COLUMN_NAME,VAR_CODE,VAR_NAME),
            by=c("demo_type"="COLUMN_NAME","demo_val"="VAR_CODE")) %>%
  dplyr::mutate(demo_val = ifelse(!is.na(VAR_NAME),VAR_NAME,demo_val)) %>%
  dplyr::select(-VAR_NAME) %>%
  unite("demo_type_cat",c("demo_type","demo_val")) %>%
  # attach totals at bottom
  bind_rows(aki_stage_ind %>%
              dplyr::select(aki_stg,stg_tot_cnt) %>% 
              unique %>% 
              dplyr::rename(enc_cnt=stg_tot_cnt) %>%
              mutate(enc_prop=round(enc_cnt/117453,2),
                     demo_type_cat="TOTAL(%/overall)") %>%
              gather(summ,summ_val,-aki_stg,-demo_type_cat) %>%
              dplyr::select(aki_stg,demo_type_cat,summ,summ_val)) %>%
  unite("stg_summ",c("aki_stg","summ")) %>%
  unique %>% spread(stg_summ,summ_val) %>%
  replace(.,is.na(.),0)

#nice print-out of demographic summaries for different AKI stages
kabel(demo_summ,caption="Table1 - Demographic Summaries at AKI1, AKI2, AKI3")
```



```{r eval=F, echo=F}
#collect all variables
cdm_vari<-get_all_var(conn,
                      cdm_db_schema="PCORNET_CDM_C4R3",
                      oracle_temp_schema=cdm_db_schema)
#save variable tables
save(cdm_vari,file="./data/cdm_vari_tbls.Rdata")
```


#### Objective 1.3: Quality Check

##### Records, Patients, Encounters and Date Range by Table

```{r eval=F}

```


##### Demographics




##### Vital: HT, WT, BMI
```{r eval=F}
#vital
#detect outliers - HT, WT, BMI
ht_wt_bmi<-AKI_VITAL %>% 
  dplyr::select(PATID, VITALID, MEASURE_DATE_TIME,
                HT,WT,ORIGINAL_BMI) %>%
  dplyr::filter(!is.na(HT) & !is.na(WT)) %>%
  left_join(AKI_DEMO %>% dplyr::select(PATID,AGE,SEX) %>% unique,
            by="PATID") %>%
  dplyr::mutate(age_grp= case_when(AGE < 30 ~ 1,
                                   AGE >= 30 & AGE < 40 ~ 2,
                                   AGE >= 40 & AGE < 50 ~ 3,
                                   AGE >= 50 & AGE < 60 ~ 4,
                                   AGE >= 60 & AGE < 70 ~ 5,
                                   AGE >= 70 ~ 6)) %>%
  dplyr::select(-AGE) %>%
  gather(key,val,-PATID,-age_grp,-SEX,-VITALID,-MEASURE_DATE_TIME) %>%
  group_by(age_grp,SEX,key) %>%
  dplyr::mutate(low_bd=ifelse(key=="ORIGINAL_BMI",
                              pmax(10,median(val,na.rm=T)-3*IQR(val,na.rm=T,type=8)),
                              pmax(50,median(val,na.rm=T)-3*IQR(val,na.rm=T,type=8))),   
                up_bd=pmin(500,median(val,na.rm=T)+4.5*IQR(val,na.rm=T,type=8))) %>% 
  ungroup %>%
  dplyr::mutate(outlier_ind = ifelse(val > up_bd | val < low_bd, 1,0))

#outliers summaries
ht_wt_bmi %>% filter(outlier_ind==1) %>%
  group_by(age_grp,SEX,key,low_bd,up_bd) %>%
  dplyr::summarize(pat_cnt=length(unique(PATID))) %>% 
  ungroup %>% unique %>% arrange(age_grp,SEX,key) %>%
  View


#detect outliers - SYSTOLIC, DIASTOLIC, at encounter level
# AKI_VITAL_test<-AKI_VITAL %>% dplyr::filter(PATID < 100)
# scalability issue!
bp<-AKI_VITAL %>% 
  dplyr::select(ENCOUNTERID,VITALID, MEASURE_DATE_TIME,
                SYSTOLIC, DIASTOLIC) %>%
  dplyr::filter(!is.na(SYSTOLIC) & !is.na(DIASTOLIC)) %>%
  gather(key,val,-ENCOUNTERID,-VITALID, -MEASURE_DATE_TIME) %>%
  group_by(key,ENCOUNTERID) %>%
  dplyr::mutate(measure_time=rank(MEASURE_DATE_TIME),
                freq=n()) %>%
  dplyr::mutate(loess_fit=predict(loess(val~measure_time),se=T)$fit,
                loess_se=predict(loess(val~measure_time),se=T)$se) %>%
  dplyr::mutate(low_bd=loess_fit-1.5*sqrt(freq)*loess_se,
                up_bd=loess_fit+1.5*sqrt(freq)*loess_se) %>%
  ungroup %>%
  dplyr::mutate(outlier_ind = ifelse(val > up_bd | val < low_bd, 1,0))


#outliers summaries
bp %>% filter(outlier_ind==1) %>%
  group_by(key) %>%
  dplyr::summarize(enc_cnt=length(unique(ENCOUNTERID)),
                   low_bd=median(low_bd),
                   low_bd_max=max(low_bd),
                   up_bd=median(up_bd),
                   up_bd=min(up_bd)) %>%
  View  
```

##### Vital: Blood Pressure



##### Vital: Smoking Status




##### Labs




##### Medications





##### Diagnosis, Procedure




