---
title: "Building and Validating Predictive Models for Acute Kidney Injury (AKI) using PCORnet CDM (Part I)"
author: "xing song"
date: "August 23, 2018"
output: html_document
---
### Aim 1: Data Feasibility Evaluation over GPC sites.
#### Objective 1.1: Study cohort extraction and characterization

##### Inclusion criteria:

* (IP,IS,EI) visits with length of stay (LOS) >= 2 days; 
* age at visit >= 18 years old

***

##### Exclusion criteria:

* had no documented SCr measurements during admission; 
* had initial SCr greater than or equal to 1.3 mg/dL; 
* developed stage 2 AKI (eGFR <= 15 mL/min per 1.73m^2) initially; 
* pre-existing chronic renal failure (DX); 
* received RRT within 48 hours since admission; 
* burn patients (DRG)

***

##### AKI Staging

AKI Stages are defined based on [KDIGO](http://www.kdigo.org/clinical_practice_guidelines/pdf/KDIGO%20AKI%20Guideline.pdf):

* AKI 1: increase in serum creatinine by >=**0.3 mg/dL** within **48 hours** OR **1.5-1.9 times** baseline within **7 days**; 
* AKI 2: **2.0 to 2.9 times** baseline within **7 days**; 
* AKI 3: increase in serum creatinine to >= **4.0 mg/dL** within **48 hours** OR **3.0 times** baseline within **7 days**


##### Implementation: Extracting AKI Study Cohort
```{r echo=FALSE}
#source utility functions
#source utility functions
source("./R/helper_functions.R")
source("./R/extract_cohort.R")

#load libraries
require_libraries(c("knitr",
                    "tidyr",
                    "dplyr",
                    "magrittr",
                    "stringr",
                    "ROracle",
                    "DBI"))


#establish the connection between r-studio and CDM server
config_file_path<-"../config.csv"
config_file<-read.csv(config_file_path,stringsAsFactors = F)
conn<-dbConnect(Oracle(),
                config_file$username,
                config_file$password,
                config_file$access)

#extract cohort --Table1
# by default, we assume cdm schema is on the same server as current schema,
# if not, set same_server=F and cdm_db_server=...(server name)
cohort<-extract_cohort(conn,
                       oracle_temp_schema=config_file$oracle_temp_schema,
                       cdm_db_schema=config_file$cdm_db_schema,
                       start_date="2010-01-01",
                       end_date="2018-12-31")

#save results
Table1<-cohort$aki_enc
consort_tbl<-cohort$attrition

# collect summaries
tbl1_summ<-Table1 %>% 
  dplyr::select(PATID, ENCOUNTERID,
                NONAKI_SINCE_ADMIT, 
                AKI1_SINCE_ADMIT,
                AKI2_SINCE_ADMIT,
                AKI3_SINCE_ADMIT) %>%
  gather(stage, days_since_admit,-PATID,-ENCOUNTERID) %>%
  mutate(stage=gsub("_.*","",stage)) %>% 
  group_by(stage) %>%
  dplyr::summarize(min_time=min(days_since_admit,na.rm=T),
                   q1_time=quantile(days_since_admit,probs=0.25,na.rm=T),
                   median_time=median(days_since_admit,na.rm=T),
                   mean_time=mean(days_since_admit,na.rm=T),
                   q3_time=quantile(days_since_admit,probs=0.75,na.rm=T),
                   max_time=max(days_since_admit,na.rm=T),
                   sd_time=sd(days_since_admit,na.rm=T)) %>%
  mutate(semi_IQR_time=0.5*(q3_time-q1_time))
  
#save results
save(Table1,file="./data/Table1.Rdata")
save(consort_tbl,file="./data/consort_tbl.Rdata")

#nice print-out of consort diagram
load("./data/consort_tbl.Rdata") #temp
kable(consort_tbl,caption="Consort Table")

#clean up
rm(cohort,consort_tbl); gc()
```

We have extracted AKI study cohort based on the "Inclusion" and "Exclusion" criteria specified above. The final output has been automatically saved in the current working directory *r getwd()* as "Table1.Rdata" with columns: *r paste(colnames(Table1),collapse=","*. The above consort diagram shows the loss of samples during the collection process, which finally resulted in *r length(unique(Table1$ENCOUNTERID))* eligible encounters for study. 


```{r echo=F}
load("./data/Table1.Rdata")

# auxilliary summaries and tables
enc_tot<-length(unique(Table1$ENCOUNTERID))
# critical dates of AKI encounters
aki_stage_ind<-Table1 %>%
  dplyr::select(PATID, ENCOUNTERID, ADMIT_DATE, DISCHARGE_DATE,
                NONAKI_ANCHOR, AKI1_ONSET,AKI2_ONSET,AKI3_ONSET) %>%
  gather(chk_pt, critical_date,-PATID,-ENCOUNTERID) %>%
  filter(!is.na(critical_date)) %>%
  mutate(chk_pt=gsub("_.*","",chk_pt)) %>%
  group_by(chk_pt) %>%
  dplyr::mutate(stg_tot_cnt=n()) %>%
  ungroup %>%
  arrange(PATID, ENCOUNTERID, chk_pt, critical_date, stg_tot_cnt)

```


#### Objective 1.2: Variable Collection and Summaries (Table by Table)
In this section, we will collect variables from PCORNET_CDM tables: *DEMOGRAPHIC*, *ENCOUNTER*, *VITAL*, *LAB_RESULT_CM*, *PRESCRIBING MEDICATION*, *DIAGNOSIS*, *PROCEDURE*, check data quality and generate variable summaries table by table.

##### Demographic 
Demographic variables include *Age (calculated from Birth_Date)*, *Sex*, *Race*, *Ethnicity*.  

```{r echo=F, eval=F}
## demographic
demo<-dbGetQuery(conn,
                 parse_sql("./inst/collect_demo.sql",
                           cdm_db_schema=config_file$cdm_db_schema)$statement) %>%
  mutate(AGE_GRP=case_when(AGE<= 25 ~ "18-25",
                           AGE >= 26 & AGE <= 35 ~ "26-35",
                           AGE >= 36 & AGE <= 45 ~ "36-45",
                           AGE >= 46 & AGE <= 55 ~ "46-55",
                           AGE >= 56 & AGE <= 65 ~ "56-65",
                           AGE >= 66 ~ "66<=")) %>%
  dplyr::select(PATID,ENCOUNTERID,
                AGE,AGE_GRP,SEX,RACE,HISPANIC,DDAYS_SINCE_ENC) %>%
  replace_na(list(AGE="NI",
                  AGE_GRP="NI",
                  SEX="NI",
                  RACE="NI",
                  HISPANIC="NI")) %>%
  gather(key,value,-PATID,-ENCOUNTERID) %>%
  unique

#collect summaries
demo_summ<-aki_stage_ind %>% 
  filter(!chk_pt %in% c("DISCHARGE")) %>%
  dplyr::select(-critical_date) %>%
  left_join(demo %>% 
              filter(!(key %in% c("AGE","DDAYS_SINCE_ENC"))), 
            by="ENCOUNTERID") %>%
  group_by(chk_pt,stg_tot_cnt,key,value) %>%
  dplyr::summarize(enc_cnt = n(),
                   enc_prop = round(n()/stg_tot_cnt[1],2)) %>%
  ungroup %>% dplyr::select(-stg_tot_cnt) %>%
  gather(summ,summ_val,-chk_pt,-key,-value) %>%
  # # decode demo_val
  # left_join(meta %>% dplyr::select(COLUMN_NAME,VAR_CODE,VAR_NAME),
  #           by=c("demo_type"="COLUMN_NAME","demo_val"="VAR_CODE")) %>%
  # dplyr::mutate(demo_val = ifelse(!is.na(VAR_NAME),VAR_NAME,demo_val)) %>%
  # dplyr::select(-VAR_NAME) %>%
  # unite("demo_type_cat",c("demo_type","demo_val")) %>%
  # attach totals at bottom
  bind_rows(aki_stage_ind %>%
              filter(!chk_pt %in% c("DISCHARGE")) %>%
              dplyr::select(chk_pt,stg_tot_cnt) %>% 
              unique %>% 
              dplyr::rename(enc_cnt=stg_tot_cnt) %>%
              mutate(enc_prop=round(enc_cnt/enc_tot,2),
                     key="TOTAL",
                     value="(%/overall)") %>%
              gather(summ,summ_val,-chk_pt,-key,-value) %>%
              dplyr::select(key,value,chk_pt,summ,summ_val)) %>%
  unite("stg_summ",c("chk_pt","summ")) %>%
  unique %>% spread(stg_summ,summ_val) %>%
  replace(.,is.na(.),0)

#save results
save(demo,file="./data/AKI_demo.Rdata")
save(demo_summ,file="./data/demo_summ.Rdata")

#nice print-out
kable(demo_summ,caption="Table1 - Demographic Summaries at AKI1, AKI2, AKI3")

#clean up
rm(demo,demo_summ); gc()
```


##### Vital 
Vital variables include: *Height*, *Weight*, *BMI*, *Blood Pressure (Systolic, Diastolic)*, *Smoking Status*. 

###### Vital: HT, WT, BMI
```{r eval=F}
## vital
vital<-dbGetQuery(conn,
                  parse_sql("./inst/collect_vital.sql",
                            cdm_db_schema=config_file$cdm_db_schema)$statement) %>%
  mutate(BMI_GRP = case_when(ORIGINAL_BMI <= 25 ~ "BMI <= 25",
                             ORIGINAL_BMI > 25 &  ORIGINAL_BMI <= 30 ~ "BMI 26-30",
                             ORIGINAL_BMI >=31  ~ "BMI >= 31")) %>%
  left_join(aki_stage_ind %>% filter(chk_pt=="ADMIT"),
            by=c("PATID","ENCOUNTERID")) %>%
  dplyr::mutate(dsa=round(as.numeric(difftime(MEASURE_DATE_TIME,critical_date,units="days")),2)) %>%
  dplyr::select(-MEASURE_DATE_TIME,-critical_date,-chk_pt,-stg_tot_cnt) %>%
  gather(key,value,-PATID,-ENCOUNTERID,-dsa) %>%
  filter(!is.na(key) & !is.na(value)) %>%
  dplyr::select(PATID,ENCOUNTERID,key,value,dsa) %>%
  mutate(key=recode(key,
                    ORIGINAL_BMI="BMI",
                    SYSTOLIC="BP_SYSTOLIC",
                    DIASTOLIC="BP_DIASTOLIC")) %>%
  unique


# collect summaries
load("./data/AKI_vital.Rdata")
vital %<>%
  dplyr::select(ENCOUNTERID, key, value, dsa) %>%
  filter(key %in% c("HT","WT","BMI","BP_DIASTOLIC","BP_SYSTOLIC")) %>%
  mutate(value=as.numeric(value)) %>%
  mutate(param_low=case_when(key=="HT" ~ 0,
                             key=="WT" ~ 0,
                             key=="BMI" ~ 0,
                             key %in% c("BP_DIASTOLIC",
                                        "BP_SYSTOLIC") ~ 40),
         param_high=case_when(key=="HT" ~ 94.99,
                              key=="WT" ~ 350,
                              key=="BMI" ~ 50,
                              key=="BP_DIASTOLIC"~120,
                              key=="BP_SYSTOLIC" ~ 210)) %>%
  mutate(dsa_grp=case_when(dsa < 0 ~ "0>",
                           dsa >=0 & dsa < 1 ~ "1",
                           dsa >=1 & dsa < 2 ~ "2",
                           dsa >=2 & dsa < 3 ~ "3",
                           dsa >=3 & dsa < 4 ~ "4",
                           dsa >=4 & dsa < 5 ~ "5",
                           dsa >=5 & dsa < 6 ~ "6",
                           dsa >=6 & dsa < 7 ~ "7",
                           dsa >=7 ~ "7<"))

vital_summ<-vital %>%
  group_by(key) %>%
  dplyr::summarize(record_cnt=n(),
                   enc_cnt=length(unique(ENCOUNTERID)),
                   low_cnt=sum((value<param_low)),
                   high_cnt=sum((value>param_high)),
                   min=min(value,na.rm=T),
                   mean=round(mean(value,na.rm=T)),
                   sd=round(sd(value,na.rm=T)),
                   median=round(median(value,na.rm=T)),
                   max=max(value,na.rm=T)) %>%
  ungroup %>%
  mutate(cov=round(sd/mean,1)) %>%
  #HIPPA, low counts masking
  mutate(enc_cnt=ifelse(as.numeric(enc_cnt)<11 & as.numeric(enc_cnt)>0,"<11",enc_cnt),
         record_cnt=ifelse(as.numeric(record_cnt)<11 & as.numeric(record_cnt)>0,"<11",record_cnt),
         low_cnt=ifelse(as.numeric(low_cnt)<11 & as.numeric(low_cnt)>0,"<11",as.character(low_cnt)),
         high_cnt=ifelse(as.numeric(high_cnt)<11 & as.numeric(high_cnt)>0,"<11",as.character(high_cnt))) %>%
  gather(summ,overall,-key) %>%
  mutate(summ=recode(summ,
                     enc_cnt="1.encounters#",
                     record_cnt="2.records#",
                     low_cnt="3.low_records#",
                     high_cnt="4.high_records#",
                     min="5a.min",
                     median="5b.median",
                     mean="5c.mean",
                     sd="5d.sd",
                     cov="5e.cov",
                     max="5f.max")) %>%
  left_join(
    vital %>%
      group_by(key,dsa_grp) %>%
      dplyr::summarize(record_cnt=n(),
                       enc_cnt=length(unique(ENCOUNTERID)),
                       low_cnt=sum((value<param_low)),
                       high_cnt=sum((value>param_high)),
                       min=min(value,na.rm=T),
                       mean=round(mean(value,na.rm=T)),
                       sd=round(sd(value,na.rm=T)),
                       median=round(median(value,na.rm=T)),
                       max=max(value,na.rm=T)) %>%
      ungroup %>%
      mutate(cov=round(sd/mean,1)) %>%
      #HIPPA, low counts masking
      mutate(enc_cnt=ifelse(as.numeric(enc_cnt)<11 & as.numeric(enc_cnt)>0,"<11",enc_cnt),
             record_cnt=ifelse(as.numeric(record_cnt)<11 & as.numeric(record_cnt)>0,"<11",record_cnt),
             low_cnt=ifelse(as.numeric(low_cnt)<11 & as.numeric(low_cnt)>0,"<11",as.character(low_cnt)),
             high_cnt=ifelse(as.numeric(high_cnt)<11 & as.numeric(high_cnt)>0,"<11",as.character(high_cnt))) %>%
      gather(summ,summ_val,-key,-dsa_grp) %>%
      spread(dsa_grp,summ_val) %>%
      mutate(summ=recode(summ,
                         enc_cnt="1.encounters#",
                         record_cnt="2.records#",
                         low_cnt="3.low_records#",
                         high_cnt="4.high_records#",
                         min="5a.min",
                         median="5b.median",
                         mean="5c.mean",
                         sd="5d.sd",
                         cov="5e.cov",
                         max="5f.max")),
    by=c("key","summ")
  ) %>%
  arrange(key,summ)


#save
save(vital,file="./data/AKI_vital.Rdata")
save(vital_summ,file="./data/vital_summ.Rdata")

#nice print-out
kabel(vital_summ,caption="Table2 - Vital (HT,WT,BMI,SBP,DBP) Summaries")

#clean up
rm(vital,vital_summ); gc()
```


###### Vital: Blood Pressure
```{r echo=FALSE, eval=FALSE}
#detect outliers - SYSTOLIC, DIASTOLIC, at encounter level
# AKI_VITAL_test<-AKI_VITAL %>% dplyr::filter(PATID < 100)
# scalability issue!
bp<-AKI_VITAL %>% 
  dplyr::select(ENCOUNTERID,VITALID, MEASURE_DATE_TIME,
                SYSTOLIC, DIASTOLIC) %>%
  dplyr::filter(!is.na(SYSTOLIC) & !is.na(DIASTOLIC)) %>%
  gather(key,val,-ENCOUNTERID,-VITALID, -MEASURE_DATE_TIME) %>%
  group_by(key,ENCOUNTERID) %>%
  dplyr::mutate(measure_time=rank(MEASURE_DATE_TIME),
                freq=n()) %>%
  dplyr::mutate(loess_fit=predict(loess(val~measure_time),se=T)$fit,
                loess_se=predict(loess(val~measure_time),se=T)$se) %>%
  dplyr::mutate(low_bd=loess_fit-1.5*sqrt(freq)*loess_se,
                up_bd=loess_fit+1.5*sqrt(freq)*loess_se) %>%
  ungroup %>%
  dplyr::mutate(outlier_ind = ifelse(val > up_bd | val < low_bd, 1,0))


#outliers summaries
bp %>% filter(outlier_ind==1) %>%
  group_by(key) %>%
  dplyr::summarize(enc_cnt=length(unique(ENCOUNTERID)),
                   low_bd=median(low_bd),
                   low_bd_max=max(low_bd),
                   up_bd=median(up_bd),
                   up_bd=min(up_bd)) %>%
  View  

```


###### Vital: Smoking Status



##### Labs



##### Medications


##### Admission DRG


##### Diagnosis


##### Procedure


##### Records, Patients, Encounters and Date Range by Table

```{r eval=F}

```



